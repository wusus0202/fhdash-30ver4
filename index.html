<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ³å’Œç›£æ¸¬ç«™ - å¤šç«™åˆ‡æ›ç‰ˆ</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f8f9fa; --card: #ffffff; --primary: #2563eb; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* ç«™é»åˆ‡æ›æŒ‰éˆ• */
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 15px; border: none; border-radius: 8px; background: #ddd; cursor: pointer; transition: 0.3s; }
        button.active { background: var(--primary); color: white; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .stat-card .value { font-size: 2.2rem; font-weight: bold; color: #1e293b; }
        
        .chart-section { background: var(--card); padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .debug-panel { margin-top: 15px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444; font-size: 0.85rem; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-group">
        <button onclick="switchStation('B827EB63D1C8', this)" class="active">å°èŠ³å ‚</button>
        <button onclick="switchStation('B827EBC2994D', this)">å¸ä»¤å°</button>
        <button onclick="switchStation('B827EB797224', this)">å­¸å‹™è™•</button>
        <button onclick="switchStation('FT7_043', this)" style="background: #10b981; color: white;">æ¸¬è©¦ç«™ (ä¿è­‰æœ‰è³‡æ–™)</button>
    </div>

    <h1 id="site-name">ğŸ« æ­£åœ¨ç›£æ¸¬ï¼šå°èŠ³å ‚</h1>
    
    <div class="stats-grid">
        <div class="stat-card"><div>PM2.5</div><div class="value" id="pm25">--</div></div>
        <div class="stat-card"><div>æº«åº¦</div><div class="value" id="temp">--</div></div>
        <div class="stat-card"><div>æ¿•åº¦</div><div class="value" id="humi">--</div></div>
        <div class="stat-card"><div>CO2</div><div class="value" id="co2">--</div></div>
    </div>

    <div class="chart-section">
        <div style="height:350px;"><canvas id="mainChart"></canvas></div>
        <div id="status" style="margin-top:10px; color:#64748b;">â— åˆå§‹åŒ–ä¸­...</div>
        <div id="debug-box" class="debug-panel"></div>
    </div>
</div>

<script>
// --- åŸºç¤é…ç½® ---
const config = {
    'A': { name: 'å°èŠ³å ‚', id: 'B827EB63D1C8', type: 'lass' },
    'B': { name: 'å¸ä»¤å°', id: 'B827EBC2994D', type: 'lass' },
    'C': { name: 'å­¸å‹™è™•', id: 'B827EB797224', type: 'lass' },
    'E': { name: 'æ¤ç‰©è§€æ¸¬', type: 'gas' }
};

const GAS_URL = "https://script.google.com/macros/s/AKfycbzAaqP79kMX9Uq_QtIqnwMx8tp2v62k6H5lDOCtCZV2W73NwfWN9kFdMz0Myalx2vxRFw/exec"; 

let currentSrc = 'A';
let gauge, historyChart, dataInterval;

// --- åˆå§‹åŒ– ---
window.onload = () => {
    initGauge();
    setupDropdown();
    updateClock();
    setInterval(updateClock, 1000);
    switchPage('A'); 
};

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

function setupDropdown() {
    const btn = document.getElementById('source-selector');
    const list = document.getElementById('source-list');
    btn.onclick = (e) => { e.stopPropagation(); list.classList.toggle('show'); };
    window.onclick = () => list.classList.remove('show');
    document.querySelectorAll('#source-list li').forEach(li => {
        li.onclick = () => {
            const src = li.dataset.source;
            btn.textContent = config[src].name + " â–¼";
            switchPage(src);
        };
    });
}

function switchPage(src) {
    currentSrc = src;
    if (dataInterval) clearInterval(dataInterval);
    
    if (config[src].type === 'gas') {
        document.getElementById('lass-view').classList.add('hidden');
        document.getElementById('plant-view').classList.remove('hidden');
        fetchPlantData();
        dataInterval = setInterval(fetchPlantData, 30000);
    } else {
        document.getElementById('lass-view').classList.remove('hidden');
        document.getElementById('plant-view').classList.add('hidden');
        fetchLassData();
        dataInterval = setInterval(fetchLassData, 30000);
    }
}

// --- æŠ“å–å³æ™‚æ•¸æ“š ---
async function fetchLassData() {
    const device = config[currentSrc];
    try {
        const res = await fetch(`https://pm25.lass-net.org/data/last.php?device_id=${device.id}`);
        const json = await res.json();
        
        if (json?.feeds?.length > 0) {
            const firstObject = json.feeds[0];
            const dataKey = Object.keys(firstObject)[0];
            const d = firstObject[dataKey];
            
            if (d) {
                updateLassUI(d);
                document.getElementById('data-status').innerHTML = `â— ${device.name} æ›´æ–°æˆåŠŸ`;
            }
        }
    } catch (e) { 
        document.getElementById('data-status').innerHTML = `â— é€£ç·šéŒ¯èª¤`; 
    }
}

async function fetchPlantData() {
    try {
        const res = await fetch(GAS_URL, { redirect: "follow" });
        const data = await res.json();
        const last = data[data.length - 1]; 
        document.getElementById('p-temp').textContent = last["æº«åº¦"] || last.temp || "--";
        document.getElementById('p-humi').textContent = last["æ¿•åº¦"] || last.humi || "--";
        document.getElementById('p-soil').textContent = last["åœŸå£¤æ¿•åº¦"] || last.soil || "--";
        document.getElementById('p-co2').textContent = last["CO2"] || last.co2 || "--";
        document.getElementById('data-status').innerHTML = `â— ESP32 é€£çµæˆåŠŸ`;
    } catch (e) { 
        document.getElementById('data-status').innerHTML = `â— æ¤ç‰©ç³»çµ±é€£ç·šå¤±æ•—`; 
    }
}

// --- æ›´æ–° UI ---
function updateLassUI(d) {
    const pm = d.s_d0 !== undefined ? Math.round(d.s_d0) : 0;
    document.getElementById('pm25-val').textContent = pm;
    const pmColor = pm < 30 ? '#3aa02d' : (pm < 70 ? '#f9ca24' : '#fa0000');
    const notice = document.getElementById('aqi-notice');
    notice.textContent = pm < 30 ? 'è‰¯å¥½' : (pm < 70 ? 'æ™®é€š' : 'ä¸è‰¯');
    notice.style.backgroundColor = pmColor;
    gauge.data.datasets[0].backgroundColor = [pmColor, '#e0e0e0'];
    gauge.data.datasets[0].data = [pm, Math.max(0, 150 - pm)];
    gauge.update();
    document.getElementById('temp-display').textContent = d.s_t0 !== undefined ? `${d.s_t0.toFixed(1)} Â°C` : "-- Â°C";
    document.getElementById('humi-display').textContent = d.s_h0 !== undefined ? `${Math.round(d.s_h0)} %` : "-- %";
    document.getElementById('co2-display').textContent = d.s_g8 !== undefined ? `${Math.round(d.s_g8)} ppm` : "-- ppm";
    document.getElementById('tvoc-display').textContent = d.s_gg !== undefined ? `${Math.round(d.s_gg)} ppb` : "-- ppb";
}

// --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¶¨å‹¢åœ–æ•¸æ“šä¸²æ¥ ---
async function openModal(label, key) {
    document.getElementById('modal-title').innerText = `${label} æ­·å²è¶¨å‹¢`;
    document.getElementById('history-modal').classList.add('active');
    
    const ctx = document.getElementById('historyChart').getContext('2d');
    if (historyChart) historyChart.destroy();
    
    // å…ˆç•«å‡ºç©ºçš„åœ–è¡¨å¤–æ®¼
    historyChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: label, data: [], borderColor: '#4a4545', backgroundColor: 'rgba(74, 69, 69, 0.1)', fill: true, tension: 0.4 }] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { title: { display: true, text: 'æ•¸æ“šè¼‰å…¥ä¸­...' } }
        }
    });

    try {
        const device = config[currentSrc];
        const res = await fetch(`https://pm25.lass-net.org/data/history.php?device_id=${device.id}`);
        const json = await res.json();
        
        const firstObj = json?.feeds?.[0];
        const hList = firstObj[Object.keys(firstObj)[0]] || [];

        if (Array.isArray(hList) && hList.length > 0) {
            const recent = hList.slice(-40); // æŠ“æœ€è¿‘ 40 ç­†
            const labels = recent.map(f => {
                const t = new Date(f.timestamp || f.time);
                return `${t.getHours()}:${String(t.getMinutes()).padStart(2, '0')}`;
            });
            const values = recent.map(f => f[key] ?? 0);

            historyChart.data.labels = labels;
            historyChart.data.datasets[0].data = values;
            historyChart.options.plugins.title.text = 'æœ€è¿‘æ•¸æ“šç´€éŒ„';
            historyChart.update();
        } else {
            historyChart.options.plugins.title.text = 'è©²ç«™é»æš«ç„¡æ­·å²æ•¸æ“š';
            historyChart.update();
        }
    } catch (e) {
        console.error("åœ–è¡¨è¼‰å…¥å¤±æ•—", e);
    }
}

function navToModal(label, key) { 
    if (window.innerWidth <= 768) toggleSidebar(); 
    openModal(label, key); 
}

function closeModal() { document.getElementById('history-modal').classList.remove('active'); }

function initGauge() {
    const ctx = document.getElementById('pm25Gauge').getContext('2d');
    gauge = new Chart(ctx, {
        type: 'doughnut',
        data: { datasets: [{ data: [0, 150], backgroundColor: ['#3aa02d', '#e0e0e0'], circumference: 270, rotation: 225, cutout: '80%', borderRadius: 10 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

function updateClock() {
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
    document.getElementById('hr').style.transform = `translateX(-50%) rotate(${(h % 12) * 30 + m * 0.5}deg)`;
    document.getElementById('mn').style.transform = `translateX(-50%) rotate(${m * 6}deg)`;
    document.getElementById('sc').style.transform = `translateX(-50%) rotate(${s * 6}deg)`;
    document.getElementById('time-display').textContent = now.toLocaleTimeString('zh-TW', {hour12: false});
    document.getElementById('date-display').textContent = now.toLocaleDateString('zh-TW', { weekday: 'short', month: 'numeric', day: 'numeric' });
}
</script>
</body>
</html>
